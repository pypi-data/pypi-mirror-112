"use strict";
/* Copyright: Ankitects Pty Ltd and contributors
 * License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var ankiPlatform = "desktop";
var typeans;
var _updatingQueue = Promise.resolve();
var onUpdateHook;
var onShownHook;
function _runHook(arr) {
    const promises = [];
    for (let i = 0; i < arr.length; i++) {
        promises.push(arr[i]());
    }
    return Promise.all(promises);
}
function _queueAction(action) {
    _updatingQueue = _updatingQueue.then(action);
}
function setInnerHTML(element, html) {
    for (const oldVideo of element.getElementsByTagName("video")) {
        oldVideo.pause();
        while (oldVideo.firstChild) {
            oldVideo.removeChild(oldVideo.firstChild);
        }
        oldVideo.load();
    }
    element.innerHTML = html;
    for (const oldScript of element.getElementsByTagName("script")) {
        const newScript = document.createElement("script");
        for (const attribute of oldScript.attributes) {
            newScript.setAttribute(attribute.name, attribute.value);
        }
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode.replaceChild(newScript, oldScript);
    }
}
function _updateQA(html, _unusused, onupdate, onshown) {
    return __awaiter(this, void 0, void 0, function* () {
        onUpdateHook = [onupdate];
        onShownHook = [onshown];
        const qa = document.getElementById("qa");
        const renderError = (kind) => (error) => {
            const errorMessage = String(error).substring(0, 2000);
            const errorStack = String(error.stack).substring(0, 2000);
            qa.innerHTML =
                `Invalid ${kind} on card: ${errorMessage}\n${errorStack}`.replace(/\n/g, "<br>");
        };
        // hide current card
        qa.style.opacity = "0";
        // update card
        try {
            setInnerHTML(qa, html);
        }
        catch (error) {
            renderError("HTML")(error);
        }
        yield _runHook(onUpdateHook);
        // wait for mathjax to ready
        yield MathJax.startup.promise
            .then(() => {
            // clear MathJax buffers from previous typesets
            MathJax.typesetClear();
            return MathJax.typesetPromise([qa]);
        })
            .catch(renderError("MathJax"));
        // and reveal card when processing is done
        qa.style.opacity = "1";
        yield _runHook(onShownHook);
    });
}
function _showQuestion(q, a, bodyclass) {
    _queueAction(() => _updateQA(q, null, function () {
        // return to top of window
        window.scrollTo(0, 0);
        document.body.className = bodyclass;
    }, function () {
        // focus typing area if visible
        typeans = document.getElementById("typeans");
        if (typeans) {
            typeans.focus();
        }
        // preload images
        allImagesLoaded().then(() => preloadAnswerImages(q, a));
    }));
}
function _showAnswer(a, bodyclass) {
    _queueAction(() => _updateQA(a, null, function () {
        if (bodyclass) {
            //  when previewing
            document.body.className = bodyclass;
        }
        // avoid scrolling to the answer until images load
        allImagesLoaded().then(scrollToAnswer);
    }, function () { }));
}
const _flagColours = {
    1: "#e25252",
    2: "#ffb347",
    3: "#54c414",
    4: "#578cff",
    5: "#ff82ee",
    6: "#00d1b5",
    7: "#9649dd",
};
function _drawFlag(flag) {
    const elem = document.getElementById("_flag");
    if (flag === 0) {
        elem.setAttribute("hidden", "");
        return;
    }
    elem.removeAttribute("hidden");
    elem.style.color = _flagColours[flag];
}
function _drawMark(mark) {
    const elem = document.getElementById("_mark");
    if (!mark) {
        elem.setAttribute("hidden", "");
    }
    else {
        elem.removeAttribute("hidden");
    }
}
function _typeAnsPress() {
    if (window.event.code === "Enter") {
        pycmd("ans");
    }
}
function _emulateMobile(enabled) {
    const list = document.documentElement.classList;
    if (enabled) {
        list.add("mobile");
    }
    else {
        list.remove("mobile");
    }
}
function allImagesLoaded() {
    return Promise.all(Array.from(document.getElementsByTagName("img")).map(imageLoaded));
}
function imageLoaded(img) {
    return img.complete
        ? Promise.resolve()
        : new Promise((resolve) => {
            img.addEventListener("load", () => resolve());
            img.addEventListener("error", () => resolve());
        });
}
function scrollToAnswer() {
    var _a;
    (_a = document.getElementById("answer")) === null || _a === void 0 ? void 0 : _a.scrollIntoView();
}
function injectPreloadLink(href, as) {
    const link = document.createElement("link");
    link.rel = "preload";
    link.href = href;
    link.as = as;
    document.head.appendChild(link);
}
function clearPreloadLinks() {
    document.head
        .querySelectorAll("link[rel='preload']")
        .forEach((link) => link.remove());
}
function extractImageSrcs(html) {
    const fragment = document.createRange().createContextualFragment(html);
    const srcs = [...fragment.querySelectorAll("img[src]")].map((img) => img.src);
    return srcs;
}
function preloadAnswerImages(qHtml, aHtml) {
    clearPreloadLinks();
    const aSrcs = extractImageSrcs(aHtml);
    if (aSrcs.length) {
        const qSrcs = extractImageSrcs(qHtml);
        const diff = aSrcs.filter((src) => !qSrcs.includes(src));
        diff.forEach((src) => injectPreloadLink(src, "image"));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV2aWV3ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9xdC9hcXQvZGF0YS93ZWIvanMvcmV2aWV3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO2tGQUNrRjs7Ozs7Ozs7OztBQU1sRixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUM7QUFDN0IsSUFBSSxPQUFnQyxDQUFDO0FBQ3JDLElBQUksY0FBYyxHQUFrQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFFdEQsSUFBSSxZQUE2QixDQUFDO0FBQ2xDLElBQUksV0FBNEIsQ0FBQztBQUVqQyxTQUFTLFFBQVEsQ0FBQyxHQUFvQjtJQUNsQyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFFcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzNCO0lBRUQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFnQjtJQUNsQyxjQUFjLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsT0FBZ0IsRUFBRSxJQUFZO0lBQ2hELEtBQUssTUFBTSxRQUFRLElBQUksT0FBTyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzFELFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVqQixPQUFPLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDeEIsUUFBUSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDN0M7UUFFRCxRQUFRLENBQUMsSUFBSSxFQUFF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QyxHQUFHLEVBQUUsRUFBRSxDQUFFLEdBQXdCLENBQUMsR0FBRyxDQUN6QyxDQUFDO0lBQ0YsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsS0FBYSxFQUFFLEtBQWE7SUFDckQsaUJBQWlCLEVBQUUsQ0FBQztJQUNwQixNQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7UUFDZCxNQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUMxRDtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBDb3B5cmlnaHQ6IEFua2l0ZWN0cyBQdHkgTHRkIGFuZCBjb250cmlidXRvcnNcbiAqIExpY2Vuc2U6IEdOVSBBR1BMLCB2ZXJzaW9uIDMgb3IgbGF0ZXI7IGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9hZ3BsLmh0bWwgKi9cblxuZGVjbGFyZSB2YXIgTWF0aEpheDogYW55O1xuXG50eXBlIENhbGxiYWNrID0gKCkgPT4gdm9pZCB8IFByb21pc2U8dm9pZD47XG5cbnZhciBhbmtpUGxhdGZvcm0gPSBcImRlc2t0b3BcIjtcbnZhciB0eXBlYW5zOiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZDtcbnZhciBfdXBkYXRpbmdRdWV1ZTogUHJvbWlzZTx2b2lkPiA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG52YXIgb25VcGRhdGVIb29rOiBBcnJheTxDYWxsYmFjaz47XG52YXIgb25TaG93bkhvb2s6IEFycmF5PENhbGxiYWNrPjtcblxuZnVuY3Rpb24gX3J1bkhvb2soYXJyOiBBcnJheTxDYWxsYmFjaz4pOiBQcm9taXNlPHZvaWRbXT4ge1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBwcm9taXNlcy5wdXNoKGFycltpXSgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuXG5mdW5jdGlvbiBfcXVldWVBY3Rpb24oYWN0aW9uOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIF91cGRhdGluZ1F1ZXVlID0gX3VwZGF0aW5nUXVldWUudGhlbihhY3Rpb24pO1xufVxuXG5mdW5jdGlvbiBzZXRJbm5lckhUTUwoZWxlbWVudDogRWxlbWVudCwgaHRtbDogc3RyaW5nKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBvbGRWaWRlbyBvZiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidmlkZW9cIikpIHtcbiAgICAgICAgb2xkVmlkZW8ucGF1c2UoKTtcblxuICAgICAgICB3aGlsZSAob2xkVmlkZW8uZmlyc3RDaGlsZCkge1xuICAgICAgICAgICAgb2xkVmlkZW8ucmVtb3ZlQ2hpbGQob2xkVmlkZW8uZmlyc3RDaGlsZCk7XG4gICAgICAgIH1cblxuICAgICAgICBvbGRWaWRlby5sb2FkKCk7XG4gICAgfVxuXG4gICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sO1xuXG4gICAgZm9yIChjb25zdCBvbGRTY3JpcHQgb2YgZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcInNjcmlwdFwiKSkge1xuICAgICAgICBjb25zdCBuZXdTY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic2NyaXB0XCIpO1xuXG4gICAgICAgIGZvciAoY29uc3QgYXR0cmlidXRlIG9mIG9sZFNjcmlwdC5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBuZXdTY3JpcHQuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZS5uYW1lLCBhdHRyaWJ1dGUudmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3U2NyaXB0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG9sZFNjcmlwdC5pbm5lckhUTUwpKTtcbiAgICAgICAgb2xkU2NyaXB0LnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld1NjcmlwdCwgb2xkU2NyaXB0KTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIF91cGRhdGVRQShcbiAgICBodG1sOiBzdHJpbmcsXG4gICAgX3VudXN1c2VkOiB1bmtub3duLFxuICAgIG9udXBkYXRlOiBDYWxsYmFjayxcbiAgICBvbnNob3duOiBDYWxsYmFja1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgb25VcGRhdGVIb29rID0gW29udXBkYXRlXTtcbiAgICBvblNob3duSG9vayA9IFtvbnNob3duXTtcblxuICAgIGNvbnN0IHFhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJxYVwiKSE7XG4gICAgY29uc3QgcmVuZGVyRXJyb3IgPVxuICAgICAgICAoa2luZDogc3RyaW5nKSA9PlxuICAgICAgICAoZXJyb3I6IEVycm9yKTogdm9pZCA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBTdHJpbmcoZXJyb3IpLnN1YnN0cmluZygwLCAyMDAwKTtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yU3RhY2sgPSBTdHJpbmcoZXJyb3Iuc3RhY2spLnN1YnN0cmluZygwLCAyMDAwKTtcbiAgICAgICAgICAgIHFhLmlubmVySFRNTCA9XG4gICAgICAgICAgICAgICAgYEludmFsaWQgJHtraW5kfSBvbiBjYXJkOiAke2Vycm9yTWVzc2FnZX1cXG4ke2Vycm9yU3RhY2t9YC5yZXBsYWNlKFxuICAgICAgICAgICAgICAgICAgICAvXFxuL2csXG4gICAgICAgICAgICAgICAgICAgIFwiPGJyPlwiXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfTtcblxuICAgIC8vIGhpZGUgY3VycmVudCBjYXJkXG4gICAgcWEuc3R5bGUub3BhY2l0eSA9IFwiMFwiO1xuXG4gICAgLy8gdXBkYXRlIGNhcmRcbiAgICB0cnkge1xuICAgICAgICBzZXRJbm5lckhUTUwocWEsIGh0bWwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlbmRlckVycm9yKFwiSFRNTFwiKShlcnJvcik7XG4gICAgfVxuXG4gICAgYXdhaXQgX3J1bkhvb2sob25VcGRhdGVIb29rKTtcblxuICAgIC8vIHdhaXQgZm9yIG1hdGhqYXggdG8gcmVhZHlcbiAgICBhd2FpdCBNYXRoSmF4LnN0YXJ0dXAucHJvbWlzZVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAvLyBjbGVhciBNYXRoSmF4IGJ1ZmZlcnMgZnJvbSBwcmV2aW91cyB0eXBlc2V0c1xuICAgICAgICAgICAgTWF0aEpheC50eXBlc2V0Q2xlYXIoKTtcblxuICAgICAgICAgICAgcmV0dXJuIE1hdGhKYXgudHlwZXNldFByb21pc2UoW3FhXSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChyZW5kZXJFcnJvcihcIk1hdGhKYXhcIikpO1xuXG4gICAgLy8gYW5kIHJldmVhbCBjYXJkIHdoZW4gcHJvY2Vzc2luZyBpcyBkb25lXG4gICAgcWEuc3R5bGUub3BhY2l0eSA9IFwiMVwiO1xuICAgIGF3YWl0IF9ydW5Ib29rKG9uU2hvd25Ib29rKTtcbn1cblxuZnVuY3Rpb24gX3Nob3dRdWVzdGlvbihxOiBzdHJpbmcsIGE6IHN0cmluZywgYm9keWNsYXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBfcXVldWVBY3Rpb24oKCkgPT5cbiAgICAgICAgX3VwZGF0ZVFBKFxuICAgICAgICAgICAgcSxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRvIHRvcCBvZiB3aW5kb3dcbiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7XG5cbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTmFtZSA9IGJvZHljbGFzcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gZm9jdXMgdHlwaW5nIGFyZWEgaWYgdmlzaWJsZVxuICAgICAgICAgICAgICAgIHR5cGVhbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInR5cGVhbnNcIik7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVhbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZWFucy5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBwcmVsb2FkIGltYWdlc1xuICAgICAgICAgICAgICAgIGFsbEltYWdlc0xvYWRlZCgpLnRoZW4oKCkgPT4gcHJlbG9hZEFuc3dlckltYWdlcyhxLCBhKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBfc2hvd0Fuc3dlcihhOiBzdHJpbmcsIGJvZHljbGFzczogc3RyaW5nKTogdm9pZCB7XG4gICAgX3F1ZXVlQWN0aW9uKCgpID0+XG4gICAgICAgIF91cGRhdGVRQShcbiAgICAgICAgICAgIGEsXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChib2R5Y2xhc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gIHdoZW4gcHJldmlld2luZ1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTmFtZSA9IGJvZHljbGFzcztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBhdm9pZCBzY3JvbGxpbmcgdG8gdGhlIGFuc3dlciB1bnRpbCBpbWFnZXMgbG9hZFxuICAgICAgICAgICAgICAgIGFsbEltYWdlc0xvYWRlZCgpLnRoZW4oc2Nyb2xsVG9BbnN3ZXIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHt9XG4gICAgICAgIClcbiAgICApO1xufVxuXG5jb25zdCBfZmxhZ0NvbG91cnMgPSB7XG4gICAgMTogXCIjZTI1MjUyXCIsXG4gICAgMjogXCIjZmZiMzQ3XCIsXG4gICAgMzogXCIjNTRjNDE0XCIsXG4gICAgNDogXCIjNTc4Y2ZmXCIsXG4gICAgNTogXCIjZmY4MmVlXCIsXG4gICAgNjogXCIjMDBkMWI1XCIsXG4gICAgNzogXCIjOTY0OWRkXCIsXG59O1xuXG5mdW5jdGlvbiBfZHJhd0ZsYWcoZmxhZzogMCB8IDEgfCAyIHwgMyB8IDQgfCA1IHwgNiB8IDcpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJfZmxhZ1wiKTtcbiAgICBpZiAoZmxhZyA9PT0gMCkge1xuICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShcImhpZGRlblwiLCBcIlwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShcImhpZGRlblwiKTtcbiAgICBlbGVtLnN0eWxlLmNvbG9yID0gX2ZsYWdDb2xvdXJzW2ZsYWddO1xufVxuXG5mdW5jdGlvbiBfZHJhd01hcmsobWFyazogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIl9tYXJrXCIpO1xuICAgIGlmICghbWFyaykge1xuICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShcImhpZGRlblwiLCBcIlwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShcImhpZGRlblwiKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIF90eXBlQW5zUHJlc3MoKTogdm9pZCB7XG4gICAgaWYgKCh3aW5kb3cuZXZlbnQgYXMgS2V5Ym9hcmRFdmVudCkuY29kZSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgIHB5Y21kKFwiYW5zXCIpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gX2VtdWxhdGVNb2JpbGUoZW5hYmxlZDogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IGxpc3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xhc3NMaXN0O1xuICAgIGlmIChlbmFibGVkKSB7XG4gICAgICAgIGxpc3QuYWRkKFwibW9iaWxlXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxpc3QucmVtb3ZlKFwibW9iaWxlXCIpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gYWxsSW1hZ2VzTG9hZGVkKCk6IFByb21pc2U8dm9pZFtdPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgICBBcnJheS5mcm9tKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaW1nXCIpKS5tYXAoaW1hZ2VMb2FkZWQpXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gaW1hZ2VMb2FkZWQoaW1nOiBIVE1MSW1hZ2VFbGVtZW50KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIGltZy5jb21wbGV0ZVxuICAgICAgICA/IFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgIDogbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgaW1nLmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsICgpID0+IHJlc29sdmUoKSk7XG4gICAgICAgICAgICAgIGltZy5hZGRFdmVudExpc3RlbmVyKFwiZXJyb3JcIiwgKCkgPT4gcmVzb2x2ZSgpKTtcbiAgICAgICAgICB9KTtcbn1cblxuZnVuY3Rpb24gc2Nyb2xsVG9BbnN3ZXIoKTogdm9pZCB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbnN3ZXJcIik/LnNjcm9sbEludG9WaWV3KCk7XG59XG5cbmZ1bmN0aW9uIGluamVjdFByZWxvYWRMaW5rKGhyZWY6IHN0cmluZywgYXM6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwibGlua1wiKTtcbiAgICBsaW5rLnJlbCA9IFwicHJlbG9hZFwiO1xuICAgIGxpbmsuaHJlZiA9IGhyZWY7XG4gICAgbGluay5hcyA9IGFzO1xuICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7XG59XG5cbmZ1bmN0aW9uIGNsZWFyUHJlbG9hZExpbmtzKCk6IHZvaWQge1xuICAgIGRvY3VtZW50LmhlYWRcbiAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJsaW5rW3JlbD0ncHJlbG9hZCddXCIpXG4gICAgICAgIC5mb3JFYWNoKChsaW5rKSA9PiBsaW5rLnJlbW92ZSgpKTtcbn1cblxuZnVuY3Rpb24gZXh0cmFjdEltYWdlU3JjcyhodG1sOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudChodG1sKTtcbiAgICBjb25zdCBzcmNzID0gWy4uLmZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJpbWdbc3JjXVwiKV0ubWFwKFxuICAgICAgICAoaW1nKSA9PiAoaW1nIGFzIEhUTUxJbWFnZUVsZW1lbnQpLnNyY1xuICAgICk7XG4gICAgcmV0dXJuIHNyY3M7XG59XG5cbmZ1bmN0aW9uIHByZWxvYWRBbnN3ZXJJbWFnZXMocUh0bWw6IHN0cmluZywgYUh0bWw6IHN0cmluZyk6IHZvaWQge1xuICAgIGNsZWFyUHJlbG9hZExpbmtzKCk7XG4gICAgY29uc3QgYVNyY3MgPSBleHRyYWN0SW1hZ2VTcmNzKGFIdG1sKTtcbiAgICBpZiAoYVNyY3MubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHFTcmNzID0gZXh0cmFjdEltYWdlU3JjcyhxSHRtbCk7XG4gICAgICAgIGNvbnN0IGRpZmYgPSBhU3Jjcy5maWx0ZXIoKHNyYykgPT4gIXFTcmNzLmluY2x1ZGVzKHNyYykpO1xuICAgICAgICBkaWZmLmZvckVhY2goKHNyYykgPT4gaW5qZWN0UHJlbG9hZExpbmsoc3JjLCBcImltYWdlXCIpKTtcbiAgICB9XG59XG4iXX0=