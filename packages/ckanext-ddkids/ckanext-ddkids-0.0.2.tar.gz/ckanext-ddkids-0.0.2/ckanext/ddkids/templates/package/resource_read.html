{% ckan_extends %}


{% block resource_inner %}
  <div class="module-content">
    <h1 class="page-heading">{{ h.resource_display_name(res) | truncate(50) }}
      {% if res.description %}
        - {{ res.description }}
      {% endif %}
    </h1>
    <div class="actions">
      {% block resource_actions %}
        {{ super() }}
      {% endblock %}
    </div>
    {% block resource_content %}
      {% block resource_read_title %}{% endblock %}
      {% block resource_read_url %}{% endblock %}
    {% endblock %}
    {% block data_preview %}
      {% if res.datastore_active %}
      <p>
        <a href="#dictionary_anchor">Data dictionary for this resource</a>
      </p>
      {% endif %}
      {{ super() }}
    {% endblock %}
  </div>
{% endblock %}

{% block resource_actions_inner %}
  {% if h.check_access('package_update', {'id':pkg.id }) %}
    <li>{% link_for _('Manage'), controller='package', action='resource_edit', id=pkg.name, resource_id=res.id, class_='btn btn-default', icon='wrench' %}</li>
  {% endif %}
  {% if res.url and h.is_url(res.url) %}
    <li>
      <div id="download_app">
        <div class="btn-group">
        <a class="btn btn-primary resource-url-analytics resource-type-{{ res.resource_type }}" href="{{ res.url }}">
          {% if res.resource_type in ('listing', 'service') %}
            <i class="fa fa-eye"></i> {{ _('View') }}
          {% elif  res.resource_type == 'api' %}
            <i class="fa fa-key"></i> {{ _('API Endpoint') }}
          {% elif (not res.has_views or not res.can_be_previewed) and not res.url_type == 'upload' %}
            <i class="fa fa-external-link"></i> {{ _('Download') }}
          {% else %}
            <i class="fa fa-arrow-circle-o-down"></i> {{ _('Download') }}
          {% endif %}
        </a>
        {% block download_resource_button %}
          {%if res.datastore_active %}
        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
          </button>
        <ul class="dropdown-menu">
          <li>
            <a href="{{ h.url_for(controller='ckanext.datastore.controller:DatastoreController', action='dump', resource_id=res.id, bom=True) }}"
              target="_blank"><span>CSV</span></a>
            <a href="{{ h.url_for(controller='ckanext.datastore.controller:DatastoreController', action='dump', resource_id=res.id, format='tsv', bom=True) }}"
              target="_blank"><span>TSV</span></a>
            <a href="{{ h.url_for(controller='ckanext.datastore.controller:DatastoreController', action='dump', resource_id=res.id, format='json') }}"
              target="_blank"><span>JSON</span></a>
          </li>
        </ul>
        {%endif%} {% endblock %}
        </div>
      </div>
    </li>
  {% endif %}
  {% if res.datastore_active %}
    <li>
      {% if res.datastore_active %}
        {% set loading_text = _('Loading...') %}
        {% set api_info_url = h.url_for(controller='api', action='snippet', ver=1, snippet_path='api_info.html', resource_id=res.id) %}
        <a class="btn btn-primary btn-success" href="{{ api_info_url }}" data-module="api-info" data-module-template="{{ api_info_url }}" data-loading-text="{{ loading_text }}"><i class="fa fa-flask fa-lg"></i> {{ _('Data API') }}</a>
      {% endif %}
    </li>
  {% endif %}
{% endblock %}

{% block resource_data_dictionary %}
  {% if res.datastore_active %}
  {% endif %}
  {{ super() }}
{% endblock %}

{% block resource_additional_information %}
  {% block resource_additional_information_inner %}
    {% if res.datastore_active %}
      <a name="dictionary_anchor"></a>
      {% set ddict=h.datastore_dictionary(res.id) %}
      <div class="module-content ddkids-dictionary">
        <h2>{{ _('Data Dictionary') }}</h2>
        <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
          <thead>
            <tr>
              <th scope="col">{{ _('Column') }}</th>
              <th scope="col">{{ _('Type') }}</th>
              <th scope="col">{{ _('Label') }}</th>
              <th scope="col">{{ _('Description') }}</th>
            </tr>
          </thead>
          {% for f in ddict %}
            <tr>
              <td>{{ f.id }}</td>
              <td>{{ f.type }}</td>
              <td>{{ h.get_translated(f.get('info', {}), 'label') }}</td>
              <td>{{ h.render_markdown(
                h.get_translated(f.get('info', {}), 'notes')) }}</td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}
  {% endblock %}
{% endblock %}
{% block secondary_content %}
{% endblock %}

{% block primary %}
  <div class="primary col-xs-12">
    {% block primary_content %}
      {{ super() }}
    {% endblock %}
  </div>
{% endblock %}

{% block resource_view_nav %}
  {% set resource_preview = h.resource_preview(c.resource, c.package) %}
  {% set multiple_views = resource_views|length > 1 %}
  {% if multiple_views %}
    {% snippet "package/snippets/resource_views_list.html",
       views=resource_views,
       pkg=pkg,
       is_edit=false,
       view_id=current_resource_view['id'],
       resource_preview=resource_preview,
       resource=c.resource,
       extra_class="nav-tabs nav-tabs-plain"
     %}
   {% endif %}
{% endblock %}

