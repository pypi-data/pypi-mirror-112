(self.webpackChunkcrosscompute_jupyterlab_extensions=self.webpackChunkcrosscompute_jupyterlab_extensions||[]).push([[248],{248:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>f});var o=n(138),s=n(611),a=n(271),r=n.n(a),c=n(533),l=n(290);const i="crosscompute",u="crosscompute:RunAutomation";class d extends o.ReactWidget{constructor(e){super(),this.logId=e}render(){return r().createElement(p,{logId:this.logId})}}function m(e){const{data:t}=e;if(!t)return null;const n=Object.entries(t.frames||{}).map((([e,t])=>{const{series:n,status:o,name:s}=t;let a;return"DONE"!==o&&void 0!==n&&(a=Object.entries(n||{}).map((([e,t])=>{const{status:n,name:o}=t;return r().createElement("div",{key:e},"[",n,"] ",o)}))),r().createElement("div",{key:e},r().createElement("h2",null,"[",o,"] ",s),a)}));return r().createElement("div",null,r().createElement("h1",null,"Progress"),n)}function b(e){const{data:t}=e;return t?r().createElement("div",null,r().createElement("h1",null,"Error"),"string"==typeof t?t:(n=t,Object.entries(n).map((([e,t])=>r().createElement("div",{key:e},r().createElement("h3",null,e),r().createElement("pre",null,"string"==typeof t?t:JSON.stringify(t))))))):null;var n}function g(e){const t=e.data;if(!t)return null;const{url:n,isReady:o}=t,s=o&&{fontWeight:"bold"};return r().createElement("div",null,r().createElement("h1",null,"Done"),r().createElement("a",{href:n,target:"_blank",style:s},o?"Click here to download":"Please wait for the download prompt"),".")}function p({logId:e}){const t=(0,a.useRef)(),[n,o]=(0,a.useState)({}),[s,u]=(0,a.useState)(),[d,p]=(0,a.useState)();return(0,a.useEffect)((()=>{const n=l.ServerConnection.makeSettings(),s=c.URLExt.join(n.baseUrl,i,"logs",e);return t.current=new EventSource(s),t.current.onmessage=function(e){console.log(e);const n=JSON.parse(e.data),{type:s,data:a}=n;switch(s){case"PROGRESS":{const{index:e,status:t,name:n}=a,[s,r]=e;o((e=>{const o=e.frames||{},a=o[s]||{},c={};if(void 0===r)void 0!==t&&(c.status=t),void 0!==n&&(c.name=n);else{const e=a.series||{},o=e[r]||{},s={};void 0!==t&&(s.status=t),void 0!==n&&(s.name=n),c.series=Object.assign(Object.assign({},e),{[r]:Object.assign(Object.assign({},o),s)})}return Object.assign(Object.assign({},e),{frames:Object.assign(Object.assign({},o),{[s]:Object.assign(Object.assign({},a),c)})})}));break}case"ERROR":u(a),t.current.close();break;case"DONE":{p(a);const{url:e}=a,n=setInterval((async()=>{200===(await fetch(e,{method:"HEAD"})).status&&(clearInterval(n),p(Object.assign(Object.assign({},a),{isReady:!0})),window.location.href=e)}),3e3);t.current.close();break}}},()=>{console.log("closing connection"),t.current&&(t.current.close(),console.log("connection closed"))}}),[]),r().createElement("div",{style:{maxHeight:"100%",maxWidth:"100%",overflow:"auto"}},r().createElement(b,{data:s}),r().createElement(g,{data:d}),r().createElement(m,{data:n}))}var h=n(129);const f={id:"crosscompute-jupyterlab-extensions:plugin",autoStart:!0,requires:[o.ICommandPalette,s.INotebookTracker],activate:function(e,t,n){e.commands.addCommand(u,{label:"Run Automation",execute:async()=>{const{context:e}=n.currentWidget;e.model.dirty&&!e.model.readOnly&&await e.save();const t=new FormData;let s;t.append("path",e.path);try{s=(await async function(e="",t={}){const n=l.ServerConnection.makeSettings(),o=c.URLExt.join(n.baseUrl,i,e);let s;try{s=await l.ServerConnection.makeRequest(o,t,n)}catch(e){throw new l.ServerConnection.NetworkError(e)}let a=await s.text();if(a.length>0)try{a=JSON.parse(a)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new l.ServerConnection.ResponseError(s,a.message||a);return a}("prints",{method:"POST",body:t})).id,function(e){new o.Dialog({title:"CrossCompute Automation",body:new d(e),host:document.body,buttons:[o.Dialog.okButton({label:"Close"})]}).launch().catch((()=>null))}(s)}catch(e){!function(e){new o.Dialog({title:"Error",body:e.message,host:document.body,buttons:[o.Dialog.okButton({label:"Ok"})]}).launch().catch((()=>null))}(e)}}}),t.addItem({command:u,category:"crosscompute"});const s=new class{constructor(e){this._app=e}createNew(e,t){const n=new o.ToolbarButton({iconClass:"crosscompute-icon",tooltip:"Run Automation",onClick:()=>{const e=n.node.children[0];e.setAttribute("disabled",""),setTimeout((()=>{e.removeAttribute("disabled")}),1e4),this._app.commands.execute(u)}});return e.toolbar.insertItem(10,"Run Automation",n),new h.DisposableDelegate((()=>{n.dispose()}))}}(e);e.docRegistry.addWidgetExtension("Notebook",s)}}}}]);